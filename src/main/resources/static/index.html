<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€é¢„çº¦ç³»ç»Ÿ - å¢å¼ºç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4a90e2; }
        body { background-color: #f0f2f5; font-family: 'PingFang SC', sans-serif; padding-bottom: 50px; }
        .booking-container { max-width: 800px; margin: 40px auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* æ—¥æœŸé€‰æ‹©æ ·å¼ */
        .date-row { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .date-item { min-width: 80px; padding: 10px; border: 2px solid #f0f0f0; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .date-item.active { border-color: var(--primary-color); background-color: #eef5ff; color: var(--primary-color); }
        
        /* æ—¶é—´æ ¼æ ·å¼ */
        .time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .time-slot { padding: 12px; border: 1px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; position: relative; }
        .time-slot:hover:not(.disabled) { background: #eef5ff; border-color: var(--primary-color); }
        .time-slot.selected { background: var(--primary-color) !important; color: white !important; border-color: var(--primary-color); }
        .time-slot.disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; border-style: dashed; }
        .capacity-tag { font-size: 0.75rem; display: block; margin-top: 4px; }
        
        .btn-confirm { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 10px; width: 100%; margin-top: 25px; font-weight: bold; }
        .btn-confirm:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div class="container">
    <div class="booking-container">
        <h4 class="text-center mb-4">ğŸ“… é¢„çº¦ç”³è¯·</h4>
        
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <input type="text" class="form-control form-control-lg" id="userName" placeholder="å§“å" style="border-radius: 10px;">
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control form-control-lg" id="studentId" placeholder="å­¦å·" style="border-radius: 10px;">
            </div>
        </div>

        <div class="date-row" id="dateList"></div>
        <div class="time-grid" id="timeGrid"></div>

        <button class="btn-confirm" onclick="submitBooking()">æäº¤é¢„çº¦</button>
        <div id="statusMsg" class="text-center mt-3 small"></div>
    </div>

    <div class="booking-container">
        <h5 class="text-center mb-4">ğŸ† é¢„çº¦è¾¾äººæ’è¡Œæ¦œ (TOP 10)</h5>
        <div style="height: 300px;">
            <canvas id="statsChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let selectedDate = "";
    let selectedTime = "";

    // --- 1. åˆå§‹åŒ–æ—¥æœŸ (æœªæ¥7å¤©) ---
    function initDates() {
        const dateList = document.getElementById('dateList');
        for (let i = 0; i < 7; i++) {
            const d = new Date();
            d.setDate(d.getDate() + i);
            const dateStr = d.toISOString().split('T')[0];
            const displayDate = (i === 0 ? "ä»Šå¤©" : (d.getMonth() + 1) + "/" + d.getDate());
            
            const item = document.createElement('div');
            item.className = `date-item ${i === 0 ? 'active' : ''}`;
            if(i === 0) selectedDate = dateStr;
            item.innerHTML = `<small>${displayDate}</small>`;
            
            item.onclick = () => {
                document.querySelectorAll('.date-item').forEach(el => el.classList.remove('active'));
                item.classList.add('active');
                selectedDate = dateStr;
                renderTimeSlots(); // åˆ‡æ¢æ—¥æœŸåé‡æ–°åˆ·æ–°æ—¶é—´æ®µå’Œåé¢
            };
            dateList.appendChild(item);
        }
    }

    // --- 2. æ¸²æŸ“æ—¶é—´æ®µå¹¶æ£€æŸ¥åç«¯åé¢ ---
    async function renderTimeSlots() {
        const timeGrid = document.getElementById('timeGrid');
        timeGrid.innerHTML = "åŠ è½½ä¸­..."; // åŠ è½½çŠ¶æ€æç¤º
        
        const slotsHtml = [];
        for (let h = 9; h <= 17; h++) {
            const timeStr = `${h}:00 - ${h+1}:00`;
            const fullTime = `${selectedDate} ${timeStr}`;
            
            try {
                // å‘åç«¯è¯·æ±‚è¯¥æ—¶æ®µçš„å‰©ä½™åé¢
                const res = await fetch(`/api/book/capacity?startTime=${encodeURIComponent(fullTime)}`);
                const remaining = parseInt(await res.text());

                const isDisabled = remaining <= 0;
                const slotId = `slot-${h}`;
                
                const div = document.createElement('div');
                div.className = `time-slot ${isDisabled ? 'disabled' : ''}`;
                div.innerHTML = `
                    <strong>${timeStr}</strong>
                    <span class="capacity-tag" style="color: ${remaining > 0 ? '#28a745' : '#dc3545'}">
                        ${remaining > 0 ? 'å‰©ä½™: ' + remaining : 'å·²æ»¡'}
                    </span>
                `;

                if (!isDisabled) {
                    div.onclick = () => {
                        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                        selectedTime = timeStr;
                    };
                }
                slotsHtml.push(div);
            } catch (e) {
                console.error("åé¢è·å–å¤±è´¥", e);
            }
        }
        
        timeGrid.innerHTML = "";
        slotsHtml.forEach(el => timeGrid.appendChild(el));
    }

    // --- 3. æäº¤é¢„çº¦ ---
    function submitBooking() {
        const name = document.getElementById('userName').value;
        const sid = document.getElementById('studentId').value;
        const msgBox = document.getElementById('statusMsg');
        
        if (!name || !sid || !selectedTime) {
            alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆå§“åã€å­¦å·å¹¶é€‰æ‹©æ—¶é—´ï¼‰");
            return;
        }

        const payload = {
            name: name,
            studentId: sid,
            startTime: `${selectedDate} ${selectedTime}`,
            status: "å·²é¢„çº¦"
        };
        
        fetch('/api/book', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.text())
        .then(text => {
            alert(text);
            if (text.includes("æˆåŠŸ")) {
                location.reload(); // æˆåŠŸååˆ·æ–°ï¼Œæ›´æ–°åé¢å’Œå›¾è¡¨
            }
        });
    }

    // --- 4. æ¸²æŸ“ç»Ÿè®¡æŸ±çŠ¶å›¾ ---
    function renderChart() {
        fetch('/api/book/stats')
            .then(res => res.json())
            .then(data => {
                // data æ ¼å¼é¢„æœŸ: [['å¼ ä¸‰', 5], ['æå››', 3]]
                const names = data.map(item => item[0]);
                const counts = data.map(item => item[1]);

                const ctx = document.getElementById('statsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: names,
                        datasets: [{
                            label: 'é¢„çº¦æ¬¡æ•°',
                            data: counts,
                            backgroundColor: 'rgba(74, 144, 226, 0.7)',
                            borderColor: 'rgba(74, 144, 226, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            });
    }

    // æ‰§è¡Œåˆå§‹åŒ–
    initDates();
    renderTimeSlots();
    renderChart();
</script>
</body>
</html>
