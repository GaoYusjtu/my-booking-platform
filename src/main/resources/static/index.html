<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>预约系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { 
            --ios-blue: #007AFF; 
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.7);
        }

        /* 修复 Safari 回弹露白问题 */
        html, body {
            height: 100%;
            margin: 0;
            background-color: #f5f7fa; /* 这里的颜色要与背景渐变起始色一致 */
        }

        body { 
            margin: 0; 
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-x: hidden;
            /* 适配刘海屏和底部横条 */
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(120px + env(safe-area-inset-bottom));
        }

        /* 固定背景层，防止滚动时背景移位 */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            z-index: -2;
        }

        /* 动态液态装饰块 */
        .bg-blob {
            position: fixed; width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(0,122,255,0.12) 0%, rgba(0,122,255,0) 70%);
            filter: blur(60px); border-radius: 50%; z-index: -1;
            animation: move 25s infinite alternate ease-in-out;
        }
        @keyframes move { from { transform: translate(-20%, -20%); } to { transform: translate(80%, 80%); } }

        /* 极致玻璃卡片 */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(30px) saturate(180%) contrast(95%);
            -webkit-backdrop-filter: blur(30px) saturate(180%) contrast(95%);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            padding: 24px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.05), 
                        inset 0 0 20px rgba(255,255,255,0.4);
            margin-bottom: 24px;
        }

        /* 页面切换弹性动画 */
        .page { display: none; padding: 20px; }
        .page.active { 
            display: block; 
            animation: spring-up 0.6s cubic-bezier(0.23, 1, 0.32, 1); 
        }
        @keyframes spring-up {
            from { opacity: 0; transform: translateY(40px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* 修复后的日期行：垂直居中、单行滚动 */
        .date-row { 
            display: flex; overflow-x: auto; gap: 12px; padding: 10px 2px; 
            align-items: center; -webkit-overflow-scrolling: touch;
        }
        .date-row::-webkit-scrollbar { display: none; }
        
        .date-btn {
            flex: 0 0 auto; padding: 10px 20px; border-radius: 16px;
            background: rgba(255, 255, 255, 0.5); border: 1px solid var(--glass-border);
            font-size: 14px; font-weight: 600; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .date-btn.active { 
            background: var(--ios-blue); color: white; border-color: transparent;
            box-shadow: 0 12px 24px -6px rgba(0, 122, 255, 0.4); /* 柔和阴影修复 */
            transform: translateY(-2px);
        }

        /* 时间格：垂直布局 */
        .time-slot-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 115px; border-radius: 20px; 
            background: rgba(255,255,255,0.35); border: 1px solid var(--glass-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.3;
        }
        .time-slot-container .time-text { font-size: 14px; font-weight: 600; }
        .time-slot-container .separator { font-size: 11px; margin: 2px 0; opacity: 0.5; }
        .time-slot-container .capacity-text { font-size: 13px; font-weight: 500; margin-top: 6px; color: var(--ios-blue); }
        
        .time-slot-container.selected {
            background: var(--ios-blue) !important; color: white !important;
            box-shadow: 0 15px 30px -8px rgba(0, 122, 255, 0.4);
            transform: scale(1.02);
        }
        .time-slot-container.selected .capacity-text { color: white; }
        .time-slot-container.disabled { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

        /* 底部导航栏适配 Safari 安全区域 */
        .ios-nav {
            position: fixed; 
            bottom: calc(30px + env(safe-area-inset-bottom)); 
            left: 50%; transform: translateX(-50%);
            width: 88%; max-width: 400px; height: 75px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(25px) saturate(160%);
            -webkit-backdrop-filter: blur(25px) saturate(160%);
            border-radius: 38px; display: flex; justify-content: space-around; align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 15px 40px -10px rgba(0,0,0,0.12); z-index: 1000;
        }
        .nav-item { color: #8E8E93; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        .nav-item.active { color: var(--ios-blue); transform: scale(1.15); }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; font-weight: 600; display: block; margin-top: 2px; }

        .form-control {
            background: rgba(255, 255, 255, 0.4); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 12px 18px; font-weight: 500;
        }
        .btn-primary-ios {
            background: var(--ios-blue); color: white; border: none;
            border-radius: 20px; font-weight: 700; transition: 0.2s;
        }
        .btn-primary-ios:active { transform: scale(0.97); opacity: 0.9; }
    </style>
</head>
<body>

<div class="bg-blob"></div>

<div class="container pt-3">
    <div id="page-book" class="page active">
        <h1 class="fw-bold mb-4 px-2" style="letter-spacing: -1px;">预约</h1>
        <div class="glass-card">
            <div class="row g-3 mb-4">
                <div class="col-6"><input type="text" class="form-control" id="userName" placeholder="姓名"></div>
                <div class="col-6"><input type="text" class="form-control" id="studentId" placeholder="学号"></div>
            </div>
            
            <p class="small fw-bold text-secondary mb-2 px-1">预约日期</p>
            <div class="date-row" id="dateList"></div>
            
            <p class="small fw-bold text-secondary mt-4 mb-2 px-1">可用时间</p>
            <div class="row g-3" id="timeGrid"></div>
            
            <button class="btn btn-primary-ios w-100 mt-5 py-3 shadow-lg" onclick="submitBooking()">提交预约申请</button>
        </div>
    </div>

    <div id="page-query" class="page">
        <h1 class="fw-bold mb-4 px-2" style="letter-spacing: -1px;">我的记录</h1>
        <div class="glass-card">
            <div class="mb-3"><input type="text" class="form-control" id="qName" placeholder="输入姓名"></div>
            <div class="mb-3"><input type="text" class="form-control" id="qSid" placeholder="输入学号"></div>
            <button class="btn btn-dark w-100 py-3 mb-4 rounded-4 fw-bold" onclick="verifyAndLoad()">验证并查询</button>
            <div id="appointmentList"></div>
        </div>
    </div>

    <div id="page-rank" class="page">
        <h1 class="fw-bold mb-4 px-2" style="letter-spacing: -1px;">活跃排行</h1>
        <div class="glass-card">
            <canvas id="statsChart" style="height: 380px;"></canvas>
        </div>
    </div>
</div>

<nav class="ios-nav">
    <div class="nav-item active" onclick="switchPage('book', this)"><i class="bi bi-calendar-heart-fill"></i><span>预约</span></div>
    <div class="nav-item" onclick="switchPage('query', this)"><i class="bi bi-person-badge-fill"></i><span>查询</span></div>
    <div class="nav-item" onclick="switchPage('rank', this)"><i class="bi bi-bar-chart-line-fill"></i><span>排行</span></div>
</nav>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    let selectedDate = "";
    let selectedTime = "";

    // 弹性页面切换
    function switchPage(pageId, el) {
        if (document.getElementById(`page-${pageId}`).classList.contains('active')) return;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        el.classList.add('active');
        if(pageId === 'rank') renderChart();
        if(pageId === 'book') renderTimeSlots();
    }

    // 初始化日期
    const dateList = document.getElementById('dateList');
    for (let i = 0; i < 7; i++) {
        const d = new Date(); d.setDate(d.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        const btn = document.createElement('div');
        btn.className = `date-btn ${i===0?'active':''}`;
        btn.innerText = i === 0 ? "今天" : (d.getMonth()+1)+"/"+d.getDate();
        if(i===0) selectedDate = dateStr;
        btn.onclick = (e) => {
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            selectedDate = dateStr;
            renderTimeSlots();
        };
        dateList.appendChild(btn);
    }

    // 批量加载时段
    async function renderTimeSlots() {
        const grid = document.getElementById('timeGrid');
        grid.innerHTML = "<p class='text-center opacity-50 w-100 py-4'>加载中...</p>";
        try {
            const res = await fetch(`/api/book/daily-capacity?date=${selectedDate}`);
            const data = await res.json();
            grid.innerHTML = "";
            for (let h = 9; h <= 17; h++) {
                const start = `${h}:00`;
                const end = `${h+1}:00`;
                const range = `${start} - ${end}`;
                const rem = data[range];
                
                const col = document.createElement('div');
                col.className = 'col-4';
                col.innerHTML = `
                    <div class="time-slot-container ${rem<=0?'disabled':''}" id="t-${h}">
                        <div class="time-text">${start}</div>
                        <div class="separator">~</div>
                        <div class="time-text">${end}</div>
                        <div class="capacity-text">剩余${rem}</div>
                    </div>`;
                
                if(rem > 0) {
                    col.onclick = () => {
                        document.querySelectorAll('.time-slot-container').forEach(s => s.classList.remove('selected'));
                        document.getElementById(`t-${h}`).classList.add('selected');
                        selectedTime = range;
                    };
                }
                grid.appendChild(col);
            }
        } catch(e) { grid.innerHTML = "<p class='text-center text-danger w-100'>连接服务器失败</p>"; }
    }

    // 验证并查询
    function verifyAndLoad() {
        const name = document.getElementById('qName').value.trim();
        const sid = document.getElementById('qSid').value.trim();
        const list = document.getElementById('appointmentList');
        if(!name || !sid) return alert("请输入姓名和学号进行验证");
        
        fetch('/api/book').then(res => res.json()).then(data => {
            const records = data.filter(a => a.name === name && a.studentId === sid);
            list.innerHTML = records.map(a => `
                <div class="glass-card mb-3" style="padding:18px; background:rgba(255,255,255,0.65)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold" style="font-size:16px">${a.startTime.split(' ')[1]} ${a.startTime.split(' ')[2]} ${a.startTime.split(' ')[3]}</div>
                            <div class="small opacity-50">${a.startTime.split(' ')[0]}</div>
                        </div>
                        <span class="badge bg-primary rounded-pill px-3">已预约</span>
                    </div>
                </div>
            `).join('') || "<div class='text-center py-5 opacity-50'><i class='bi bi-inbox fs-1'></i><p class='mt-2'>未找到相关预约</p></div>";
        });
    }

    // 提交预约
    function submitBooking() {
        const name = document.getElementById('userName').value.trim();
        const sid = document.getElementById('studentId').value.trim();
        if(!name || !sid || !selectedTime) return alert("请确保姓名、学号已填写并选择了时段");
        
        fetch('/api/book', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, studentId: sid, startTime: `${selectedDate} ${selectedTime}`})
        }).then(res => res.text()).then(text => {
            alert(text);
            if(text.includes("成功")) location.reload();
        });
    }

    // 渲染排行榜
    let myChart = null;
    function renderChart() {
        fetch('/api/book/stats').then(res => res.json()).then(data => {
            const ctx = document.getElementById('statsChart').getContext('2d');
            if(myChart) myChart.destroy();
            Chart.register(ChartDataLabels);
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{ 
                        data: data.map(d => d[1]), 
                        backgroundColor: 'rgba(0,122,255,0.5)', 
                        borderRadius: 15,
                        barThickness: 24
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: { 
                            align: 'right', anchor: 'end', color: '#007AFF', 
                            font: { weight: 'bold', size: 13 },
                            formatter: (v) => v + '次'
                        } 
                    },
                    scales: { 
                        x: { display: false }, 
                        y: { 
                            grid: { display: false }, 
                            border: { display: false },
                            ticks: { color: '#1d1d1f', font: { size: 14, weight: '500' } }
                        } 
                    }
                }
            });
        });
    }

    // 初始化加载
    renderTimeSlots();
</script>
</body>
</html>
