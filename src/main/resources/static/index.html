<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€é¢„çº¦ç³»ç»Ÿ - æé€Ÿç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #4a90e2; }
        body { background-color: #f0f2f5; font-family: 'PingFang SC', sans-serif; padding-bottom: 50px; }
        .booking-container { max-width: 800px; margin: 20px auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .date-row { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .date-item { min-width: 80px; padding: 10px; border: 2px solid #f0f0f0; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.3s; }
        .date-item.active { border-color: var(--primary-color); background-color: #eef5ff; color: var(--primary-color); }
        .time-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .time-slot { padding: 12px; border: 1px solid #eee; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; background: #fafafa; }
        .time-slot.selected { background: var(--primary-color) !important; color: white !important; }
        .time-slot.disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; opacity: 0.6; }
        .btn-confirm { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 10px; width: 100%; margin-top: 25px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="booking-container">
        <h4 class="text-center mb-4">ğŸ“… å¿«é€Ÿé¢„çº¦</h4>
        <div class="row g-2 mb-4">
            <div class="col-6"><input type="text" class="form-control" id="userName" placeholder="å§“å"></div>
            <div class="col-6"><input type="text" class="form-control" id="studentId" placeholder="å­¦å·"></div>
        </div>
        <div class="date-row" id="dateList"></div>
        <div class="time-grid" id="timeGrid"></div>
        <button class="btn-confirm" onclick="submitBooking()">æäº¤é¢„çº¦</button>
    </div>

    <div class="booking-container">
        <h5 class="mb-3">ğŸ† é¢„çº¦è¾¾äºº (æ¬¡æ•°)</h5>
        <div style="height: 250px;"><canvas id="statsChart"></canvas></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    let selectedDate = "";
    let selectedTime = "";

    // 1. åˆå§‹åŒ–æ—¥æœŸ
    const dateList = document.getElementById('dateList');
    for (let i = 0; i < 7; i++) {
        const d = new Date();
        d.setDate(d.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        const item = document.createElement('div');
        item.className = `date-item ${i === 0 ? 'active' : ''}`;
        if(i === 0) selectedDate = dateStr;
        item.innerHTML = `<small>${i === 0 ? "ä»Šå¤©" : (d.getMonth() + 1) + "/" + d.getDate()}</small>`;
        item.onclick = () => {
            document.querySelectorAll('.date-item').forEach(el => el.classList.remove('active'));
            item.classList.add('active');
            selectedDate = dateStr;
            renderTimeSlots();
        };
        dateList.appendChild(item);
    }

    // 2. ä¼˜åŒ–åçš„æ—¶é—´æ®µæ¸²æŸ“ï¼ˆå•æ¬¡è¯·æ±‚ï¼Œæ€§èƒ½æå‡ 90%ï¼‰
    async function renderTimeSlots() {
        const timeGrid = document.getElementById('timeGrid');
        timeGrid.innerHTML = "åŠ è½½ä¸­...";
        
        try {
            // è¯·æ±‚å½“å¤©çš„å…¨é‡åé¢æ•°æ®
            const response = await fetch(`/api/book/daily-capacity?date=${selectedDate}`);
            const capacityMap = await response.json();
            
            timeGrid.innerHTML = "";
            for (let h = 9; h <= 17; h++) {
                const timeStr = `${h}:00 - ${h+1}:00`;
                const remaining = capacityMap[timeStr];
                
                const div = document.createElement('div');
                div.className = `time-slot ${remaining <= 0 ? 'disabled' : ''}`;
                div.innerHTML = `<div>${timeStr}</div><small style="font-size:10px">å‰©ä½™: ${remaining}</small>`;
                
                if (remaining > 0) {
                    div.onclick = () => {
                        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                        div.classList.add('selected');
                        selectedTime = timeStr;
                    };
                }
                timeGrid.appendChild(div);
            }
        } catch (e) { timeGrid.innerHTML = "åŠ è½½å¤±è´¥"; }
    }

    // 3. æäº¤é¢„çº¦
    function submitBooking() {
        const name = document.getElementById('userName').value;
        const sid = document.getElementById('studentId').value;
        if (!name || !sid || !selectedTime) return alert("è¯·å®Œæ•´å¡«å†™");

        fetch('/api/book', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, studentId: sid, startTime: `${selectedDate} ${selectedTime}` })
        }).then(res => res.text()).then(text => {
            alert(text);
            location.reload();
        });
    }

    // 4. æ°´å¹³æŸ±çŠ¶å›¾ä¼˜åŒ–
    function renderChart() {
        fetch('/api/book/stats').then(res => res.json()).then(data => {
            Chart.register(ChartDataLabels); // æ³¨å†Œæ’ä»¶
            new Chart(document.getElementById('statsChart'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        data: data.map(d => d[1]),
                        backgroundColor: '#4a90e2',
                        borderRadius: 20,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y', // æ”¹ä¸ºæ°´å¹³æŸ±çŠ¶å›¾
                    plugins: {
                        legend: { display: false },
                        datalabels: { // åœ¨æŸ±å­è¾¹æ˜¾ç¤ºæ•°å­—
                            anchor: 'end',
                            align: 'right',
                            color: '#4a90e2',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        x: { display: false }, // éšè— X è½´
                        y: { 
                            display: true, 
                            grid: { display: false }, // éšè— Y è½´ç½‘æ ¼çº¿
                            border: { display: false } // éšè— Y è½´è¾¹æ¡†çº¿
                        }
                    }
                }
            });
        });
    }

    renderTimeSlots();
    renderChart();
</script>
</body>
</html>
